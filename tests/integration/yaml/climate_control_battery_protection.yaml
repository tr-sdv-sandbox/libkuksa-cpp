# Climate Control Battery Protection Integration Test
#
# This test verifies that the climate control protection system correctly
# shuts down HVAC when battery voltage drops to critical levels.
#
# Architecture:
# - KUKSA databroker (container)
# - Fixture runner (container) simulating battery sensor
# - Climate control app (test subject on host)

test_suite:
  name: Climate Control Battery Protection
  description: Verify HVAC shutdown when battery voltage critical

  # Fixtures simulate external sensors/actuators
  fixtures:
    - name: battery_sensor
      type: sensor
      config:
        signal: Vehicle.LowVoltageBattery.CurrentVoltage
        initial_value: "24.5"
        update_interval_ms: "100"

    - name: hvac_actuator
      type: actuator
      config:
        signal: Vehicle.Cabin.HVAC.IsAirConditioningActive
        initial_value: "true"

  # Global setup - runs once before all test cases
  setup:
    - inject:
        path: Vehicle.OBD.FuelLevel
        value: 75.0
    - inject:
        path: Vehicle.Powertrain.CombustionEngine.IsRunning
        value: false
    - wait: 1.0

  # Test cases
  test_cases:
    # Test Case 1: Normal operation with good battery
    - name: Normal Operation with Good Battery
      description: System allows HVAC to run when battery voltage is normal

      steps:
        - log: "=== Test 1: Normal battery voltage ==="
        - inject:
            path: Vehicle.LowVoltageBattery.CurrentVoltage
            value: 24.5
        - wait: 2.0
        - expect:
            path: Vehicle.Cabin.HVAC.IsAirConditioningActive
            value: true
            timeout: 3.0
        - log: "HVAC remains active with good battery"

    # Test Case 2: Battery protection triggers
    - name: Battery Protection Triggers on Low Voltage
      description: System shuts down HVAC when battery drops to critical level

      setup:
        - inject:
            path: Vehicle.LowVoltageBattery.CurrentVoltage
            value: 24.5
        - inject:
            path: Vehicle.Cabin.HVAC.IsAirConditioningActive
            value: true
        - wait: 1.0

      steps:
        - log: "=== Test 2: Battery voltage drops to critical ==="
        - inject:
            path: Vehicle.LowVoltageBattery.CurrentVoltage
            value: 23.0
        - wait: 2.0
        - expect:
            path: Vehicle.Cabin.HVAC.IsAirConditioningActive
            value: false
            timeout: 5.0
        - log: "Battery protection triggered - HVAC shut down"

      teardown:
        - log: "Battery protection test completed"

    # Test Case 3: Recovery after battery voltage recovers
    - name: System Recovers When Battery Voltage Improves
      description: HVAC can be reactivated after battery voltage recovers

      setup:
        - inject:
            path: Vehicle.LowVoltageBattery.CurrentVoltage
            value: 23.0
        - inject:
            path: Vehicle.Cabin.HVAC.IsAirConditioningActive
            value: false
        - wait: 1.0

      steps:
        - log: "=== Test 3: Battery recovers to safe level ==="
        - inject:
            path: Vehicle.LowVoltageBattery.CurrentVoltage
            value: 25.0
        - wait: 1.0
        - inject:
            path: Vehicle.Cabin.HVAC.IsAirConditioningActive
            value: true
        - wait: 1.0
        - expect:
            path: Vehicle.Cabin.HVAC.IsAirConditioningActive
            value: true
            timeout: 3.0
        - log: "System recovered - HVAC operational"

  # Global teardown - runs once after all test cases
  teardown:
    - log: "Climate control battery protection tests completed"
